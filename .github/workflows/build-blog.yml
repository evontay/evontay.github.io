const { Client } = require('@notionhq/client');
const { NotionToMarkdown } = require('notion-to-md');
const { marked } = require('marked');
const fs = require('fs');
const path = require('path');

// Blog post template
const blogTemplate = (title, date, content, excerpt) => `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="${excerpt || ''}">
    <title>${title} - Evon Tay</title>
    <link rel="stylesheet" href="../../reset.css">
    <link rel="stylesheet" href="../../app.css">
</head>
<body>
    <header>
        <nav>
            <a href="../../index.html">Home</a>
            <a href="../index.html">Blog</a>
        </nav>
    </header>
    
    <main class="blog-post">
        <article>
            <h1>${title}</h1>
            <time datetime="${date}">${new Date(date).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}</time>
            
            <div class="content">
                ${content}
            </div>
        </article>
    </main>
    
    <footer>
        <p>&copy; ${new Date().getFullYear()} Evon Tay</p>
    </footer>
</body>
</html>`;

// Blog listing template
const blogListingTemplate = (posts) => `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog - Evon Tay</title>
    <link rel="stylesheet" href="../reset.css">
    <link rel="stylesheet" href="../app.css">
</head>
<body>
    <header>
        <nav>
            <a href="../index.html">Home</a>
            <a href="index.html">Blog</a>
        </nav>
    </header>
    
    <main class="blog-listing">
        <h1>Blog</h1>
        
        ${posts.length > 0 ? `
        <div class="posts">
            ${posts.map(post => `
                <article class="post-preview">
                    <h2><a href="posts/${post.slug}.html">${post.title}</a></h2>
                    <time datetime="${post.date}">${new Date(post.date).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</time>
                    <p>${post.excerpt || ''}</p>
                    <a href="posts/${post.slug}.html" class="read-more">Read more ‚Üí</a>
                </article>
            `).join('\n')}
        </div>
        ` : '<p>No blog posts yet. Check back soon!</p>'}
    </main>
    
    <footer>
        <p>&copy; ${new Date().getFullYear()} Evon Tay</p>
    </footer>
</body>
</html>`;

async function buildBlog() {
  try {
    console.log('Starting blog build...');
    
    // Validate environment variables
    if (!process.env.NOTION_API_KEY) {
      throw new Error('NOTION_API_KEY environment variable is not set');
    }
    if (!process.env.NOTION_DATABASE_ID) {
      throw new Error('NOTION_DATABASE_ID environment variable is not set');
    }

    console.log('Notion API Key: Set ‚úì');
    console.log('Database ID: Set ‚úì');

    // Initialize Notion client
    console.log('Initializing Notion client...');
    const notion = new Client({
      auth: process.env.NOTION_API_KEY,
    });

    const n2m = new NotionToMarkdown({ notionClient: notion });

    console.log('Fetching posts from Notion...');
    
    // Query database for published posts
    const databaseId = process.env.NOTION_DATABASE_ID.replace(/-/g, '');
    
    const response = await notion.databases.query({
      database_id: databaseId,
      filter: {
        property: 'Published',
        checkbox: {
          equals: true,
        },
      },
      sorts: [
        {
          property: 'Date',
          direction: 'descending',
        },
      ],
    });

    console.log(`Found ${response.results.length} published posts`);

    const posts = [];

    // Create blog directories if they don't exist
    const blogDir = path.join(process.cwd(), 'blog');
    const postsDir = path.join(blogDir, 'posts');
    
    if (!fs.existsSync(blogDir)) {
      console.log('Creating blog directory...');
      fs.mkdirSync(blogDir);
    }
    if (!fs.existsSync(postsDir)) {
      console.log('Creating posts directory...');
      fs.mkdirSync(postsDir);
    }

    // Process each post
    for (const page of response.results) {
      try {
        // Safely extract properties
        const titleProp = page.properties.Title || page.properties.title || page.properties.Name || page.properties.name;
        const slugProp = page.properties.Slug || page.properties.slug;
        const dateProp = page.properties.Date || page.properties.date;
        const excerptProp = page.properties.Excerpt || page.properties.excerpt;

        const title = titleProp?.title?.[0]?.plain_text || 'Untitled';
        const slug = slugProp?.rich_text?.[0]?.plain_text || slugProp?.title?.[0]?.plain_text || 'untitled';
        const date = dateProp?.date?.start || new Date().toISOString();
        const excerpt = excerptProp?.rich_text?.[0]?.plain_text || '';

        console.log(`Processing: ${title} (${slug})`);

        // Get page content
        const mdblocks = await n2m.pageToMarkdown(page.id);
        const mdString = n2m.toMarkdownString(mdblocks);
        const htmlContent = marked.parse(mdString.parent || mdString);

        // Generate HTML file
        const html = blogTemplate(title, date, htmlContent, excerpt);
        const filePath = path.join(postsDir, `${slug}.html`);
        fs.writeFileSync(filePath, html);
        console.log(`  ‚úì Created ${slug}.html`);

        posts.push({ title, slug, date, excerpt });
      } catch (error) {
        console.error(`Error processing post:`, error.message);
        // Continue with other posts even if one fails
      }
    }

    // Generate blog listing page
    console.log('Generating blog listing page...');
    const listingHtml = blogListingTemplate(posts);
    fs.writeFileSync(
      path.join(blogDir, 'index.html'),
      listingHtml
    );

    console.log(`\n‚úÖ Successfully generated ${posts.length} blog posts!`);
    console.log('Blog listing page created at blog/index.html');
    
    if (posts.length === 0) {
      console.log('\n‚ö†Ô∏è  No published posts found. Make sure:');
      console.log('   1. You have posts in your Notion database');
      console.log('   2. The "Published" checkbox is checked');
      console.log('   3. The integration has access to the database');
    }
  } catch (error) {
    console.error('\n‚ùå Error building blog:');
    console.error('Message:', error.message);
    console.error('\nFull error:', error);
    
    if (error.message.includes('Could not find database')) {
      console.error('\nüí° Check that:');
      console.error('   1. Database ID is correct');
      console.error('   2. Integration has access to the database (check Connections in Notion)');
    }
    
    process.exit(1);
  }
}

buildBlog();
